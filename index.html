import React, { useState, useEffect } from 'react';
import { Play, RotateCcw, CheckCircle, HelpCircle, Trophy } from 'lucide-react';

const PathGame = () => {
  // éŠæˆ²ç‹€æ…‹
  const [monkeyStep, setMonkeyStep] = useState(0);
  const [rabbitStep, setRabbitStep] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [showConfetti, setShowConfetti] = useState(false);

  // æ ¼å­è¨­å®š (4åˆ— 3è¡Œ)
  const cols = 4;
  const rows = 3;
  const unitSize = 60; // æ¯å€‹æ ¼å­çš„åƒç´ å¤§å°
  
  // ç¸½æ­¥æ•¸
  const maxSteps = 7;

  // è·¯å¾‘åº§æ¨™å®šç¾© (x, y) - åŸºæ–¼æ ¼ç·šäº¤é»
  // çŒ´å­è·¯å¾‘: (0,0) -> ä¸‹2 -> å³2 -> ä¸‹1 -> å³2
  const getMonkeyPos = (step) => {
    const path = [
      {x: 0, y: 0}, // èµ·é»
      {x: 0, y: 1}, // ä¸‹
      {x: 0, y: 2}, // ä¸‹
      {x: 1, y: 2}, // å³
      {x: 2, y: 2}, // å³
      {x: 2, y: 3}, // ä¸‹
      {x: 3, y: 3}, // å³
      {x: 4, y: 3}, // å³ (çµ‚é»)
    ];
    return path[step] || path[path.length - 1];
  };

  // å…”å­è·¯å¾‘: (0,0) -> å³4 -> ä¸‹3
  const getRabbitPos = (step) => {
    const path = [
      {x: 0, y: 0}, // èµ·é»
      {x: 1, y: 0}, // å³
      {x: 2, y: 0}, // å³
      {x: 3, y: 0}, // å³
      {x: 4, y: 0}, // å³
      {x: 4, y: 1}, // ä¸‹
      {x: 4, y: 2}, // ä¸‹
      {x: 4, y: 3}, // ä¸‹ (çµ‚é»)
    ];
    return path[step] || path[path.length - 1];
  };

  const handleMonkeyWalk = () => {
    if (monkeyStep < maxSteps) {
      setMonkeyStep(prev => prev + 1);
    }
  };

  const handleRabbitWalk = () => {
    if (rabbitStep < maxSteps) {
      setRabbitStep(prev => prev + 1);
    }
  };

  const handleReset = () => {
    setMonkeyStep(0);
    setRabbitStep(0);
    setSelectedAnswer(null);
    setShowResult(false);
    setIsCorrect(false);
    setShowConfetti(false);
  };

  const checkAnswer = (answerIndex) => {
    setSelectedAnswer(answerIndex);
    setShowResult(true);
    
    // 0: çŒ´å­é•·, 1: å…”å­é•·, 2: ä¸€æ¨£é•· (æ­£ç¢ºç­”æ¡ˆ)
    if (answerIndex === 2) {
      setIsCorrect(true);
      triggerConfetti();
    } else {
      setIsCorrect(false);
    }
  };

  const triggerConfetti = () => {
    setShowConfetti(true);
    setTimeout(() => setShowConfetti(false), 3000);
  };

  // è‡ªå‹•ç•«ç·šçš„è¼”åŠ©å‡½æ•¸
  const renderPathLine = (getPosFunc, currentStep, color) => {
    let lines = [];
    for (let i = 0; i < currentStep; i++) {
      const start = getPosFunc(i);
      const end = getPosFunc(i + 1);
      lines.push(
        <line
          key={i}
          x1={start.x * unitSize + 20}
          y1={start.y * unitSize + 20}
          x2={end.x * unitSize + 20}
          y2={end.y * unitSize + 20}
          stroke={color}
          strokeWidth="6"
          strokeLinecap="round"
        />
      );
    }
    return lines;
  };

  return (
    <div className="min-h-screen bg-green-50 flex flex-col items-center py-8 font-sans">
      {/* æ¨™é¡Œå€ */}
      <div className="bg-white p-4 rounded-2xl shadow-lg mb-6 max-w-2xl w-full text-center border-b-4 border-green-200">
        <h1 className="text-2xl font-bold text-gray-800 mb-2">
          ğŸ¢ éŠæ¨‚å ´è·¯ç·šå¤§æ¯”æ‹¼
        </h1>
        <p className="text-gray-600">
          å°çŒ´å­å’Œå°å…”å­è¦å»éŠæ¨‚å ´ï¼Œå¹«å¿™é‡ä¸€é‡èª°èµ°çš„è·¯æ¯”è¼ƒé•·ï¼Ÿ
        </p>
      </div>

      {/* éŠæˆ²ä¸»ç•«é¢ */}
      <div className="bg-white p-6 rounded-3xl shadow-xl mb-6 relative overflow-hidden">
        {/* Confetti Effect (Simple CSS implementation for demo) */}
        {showConfetti && (
          <div className="absolute inset-0 pointer-events-none z-50 flex justify-center items-center">
            <div className="text-6xl animate-bounce">ğŸ‰ ç­”å°äº†ï¼ ğŸ‰</div>
          </div>
        )}

        {/* å ´æ™¯å®¹å™¨ */}
        <div className="relative" style={{ width: cols * unitSize + 40, height: rows * unitSize + 40 }}>
          
          {/* èƒŒæ™¯è‰åœ°èˆ‡è£é£¾ */}
          <div className="absolute top-0 right-0 -mt-8 -mr-8 opacity-20">
            <div className="text-6xl">ğŸ¡</div>
          </div>

          {/* SVG æ ¼ç·šå±¤ */}
          <svg width="100%" height="100%" className="absolute top-0 left-0 z-0">
            {/* ç¹ªè£½ç¶²æ ¼ */}
            {Array.from({ length: rows + 1 }).map((_, r) => (
              <line 
                key={`r-${r}`} 
                x1={20} y1={r * unitSize + 20} 
                x2={cols * unitSize + 20} y2={r * unitSize + 20} 
                stroke="#e5e7eb" strokeWidth="2" 
              />
            ))}
            {Array.from({ length: cols + 1 }).map((_, c) => (
              <line 
                key={`c-${c}`} 
                x1={c * unitSize + 20} y1={20} 
                x2={c * unitSize + 20} y2={rows * unitSize + 20} 
                stroke="#e5e7eb" strokeWidth="2" 
              />
            ))}

            {/* è·¯å¾‘ç·šæ¢ (å‹•æ…‹ç”Ÿæˆ) */}
            {renderPathLine(getMonkeyPos, monkeyStep, "#9333ea")} {/* Purple */}
            {renderPathLine(getRabbitPos, rabbitStep, "#f97316")} {/* Orange */}
          </svg>

          {/* èµ·é»æ¨™è¨˜ */}
          <div className="absolute top-0 left-0 text-xl font-bold" style={{ transform: 'translate(0px, -10px)' }}>ğŸš©</div>

          {/* çµ‚é»æ¨™è¨˜ (éŠæ¨‚å ´) */}
          <div 
            className="absolute text-4xl" 
            style={{ 
              left: cols * unitSize + 5, 
              top: rows * unitSize - 10 
            }}
          >
            ğŸ¡
          </div>

          {/* è§’è‰² - å°çŒ´å­ */}
          <div 
            className="absolute transition-all duration-300 ease-out flex flex-col items-center justify-center z-10"
            style={{
              left: getMonkeyPos(monkeyStep).x * unitSize,
              top: getMonkeyPos(monkeyStep).y * unitSize,
              transform: 'translate(0, 0)' // Adjust for icon center
            }}
          >
            <div className="w-10 h-10 bg-purple-100 rounded-full border-2 border-purple-600 flex items-center justify-center text-2xl shadow-md">
              ğŸµ
            </div>
            {monkeyStep > 0 && (
              <span className="bg-purple-600 text-white text-xs font-bold px-2 py-0.5 rounded-full mt-1">
                {monkeyStep}
              </span>
            )}
          </div>

          {/* è§’è‰² - å°å…”å­ */}
          <div 
            className="absolute transition-all duration-300 ease-out flex flex-col items-center justify-center z-10"
            style={{
              left: getRabbitPos(rabbitStep).x * unitSize,
              top: getRabbitPos(rabbitStep).y * unitSize,
              transform: 'translate(10px, 10px)' // Slightly offset to not overlap perfectly at start
            }}
          >
            <div className="w-10 h-10 bg-orange-100 rounded-full border-2 border-orange-500 flex items-center justify-center text-2xl shadow-md">
              ğŸ°
            </div>
            {rabbitStep > 0 && (
              <span className="bg-orange-500 text-white text-xs font-bold px-2 py-0.5 rounded-full mt-1">
                {rabbitStep}
              </span>
            )}
          </div>
        </div>
      </div>

      {/* æ§åˆ¶å€ */}
      <div className="grid grid-cols-2 gap-4 w-full max-w-lg px-4 mb-8">
        <button 
          onClick={handleMonkeyWalk}
          disabled={monkeyStep >= maxSteps}
          className={`flex items-center justify-center gap-2 p-4 rounded-xl shadow-md transition-all ${
            monkeyStep >= maxSteps 
              ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
              : 'bg-purple-600 text-white hover:bg-purple-700 active:scale-95'
          }`}
        >
          <Play size={20} />
          <span>è®“çŒ´å­èµ°ä¸€æ­¥ ({monkeyStep}/{maxSteps})</span>
        </button>

        <button 
          onClick={handleRabbitWalk}
          disabled={rabbitStep >= maxSteps}
          className={`flex items-center justify-center gap-2 p-4 rounded-xl shadow-md transition-all ${
            rabbitStep >= maxSteps 
              ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
              : 'bg-orange-500 text-white hover:bg-orange-600 active:scale-95'
          }`}
        >
          <Play size={20} />
          <span>è®“å…”å­èµ°ä¸€æ­¥ ({rabbitStep}/{maxSteps})</span>
        </button>
      </div>

      {/* ä½œç­”å€ */}
      {monkeyStep === maxSteps && rabbitStep === maxSteps && (
        <div className="bg-white p-6 rounded-2xl shadow-lg w-full max-w-lg border-2 border-yellow-200 animate-fade-in px-4">
          <h2 className="text-xl font-bold text-center mb-4 flex items-center justify-center gap-2">
            <HelpCircle className="text-yellow-500" />
            èª°èµ°çš„è·¯æ¯”è¼ƒé•·ï¼Ÿ
          </h2>
          
          <div className="space-y-3">
            {[
              { id: 0, text: "å°çŒ´å­èµ°çš„è·¯æ¯”è¼ƒé•·", correct: false },
              { id: 1, text: "å°å…”å­èµ°çš„è·¯æ¯”è¼ƒé•·", correct: false },
              { id: 2, text: "å°çŒ´å­å’Œå°å…”å­èµ°çš„è·¯ä¸€æ¨£é•·", correct: true }
            ].map((option) => (
              <button
                key={option.id}
                onClick={() => checkAnswer(option.id)}
                className={`w-full p-4 rounded-xl text-lg font-medium transition-all flex items-center justify-between group ${
                  selectedAnswer === option.id
                    ? isCorrect && option.correct
                      ? 'bg-green-100 border-2 border-green-500 text-green-700'
                      : !isCorrect && selectedAnswer === option.id
                        ? 'bg-red-100 border-2 border-red-500 text-red-700'
                        : 'bg-gray-100'
                    : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent hover:border-gray-200'
                }`}
              >
                <div className="flex items-center gap-3">
                  <div className={`w-6 h-6 rounded border-2 flex items-center justify-center ${
                    selectedAnswer === option.id ? 'border-current' : 'border-gray-300'
                  }`}>
                    {selectedAnswer === option.id && <div className="w-3 h-3 bg-current rounded-sm" />}
                  </div>
                  {option.text}
                </div>
                {selectedAnswer === option.id && (
                  isCorrect && option.correct ? <CheckCircle className="text-green-600" /> : null
                )}
              </button>
            ))}
          </div>

          {/* çµæœå›é¥‹ */}
          {showResult && (
            <div className={`mt-4 p-4 rounded-xl text-center ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
              {isCorrect ? (
                <div>
                  <div className="text-xl font-bold mb-1 flex items-center justify-center gap-2">
                    <Trophy className="text-yellow-600" /> ç­”å°äº†ï¼
                  </div>
                  <p>å› ç‚ºçŒ´å­èµ°äº† 7 æ ¼ï¼Œå…”å­ä¹Ÿèµ°äº† 7 æ ¼ï¼Œæ‰€ä»¥æ˜¯ä¸€æ¨£é•·çš„ï¼</p>
                </div>
              ) : (
                <div>
                  <p className="font-bold">å†æƒ³ä¸€æƒ³å–”ï¼ğŸ¤”</p>
                  <p>çœ‹çœ‹ä¸Šé¢ä»–å€‘èº«ä¸ŠèƒŒè‘—çš„æ•¸å­—æ˜¯å¤šå°‘ï¼Ÿ</p>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* é‡ç½®æŒ‰éˆ• */}
      <button 
        onClick={handleReset}
        className="mt-8 flex items-center gap-2 text-gray-500 hover:text-gray-700 transition-colors"
      >
        <RotateCcw size={16} />
        é‡æ–°é–‹å§‹
      </button>

      <style>{`
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-out forwards;
        }
      `}</style>
    </div>
  );
};

export default PathGame;
